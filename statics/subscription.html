<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>订阅管理 - RssAny</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; color: #111 }

    .topbar { height: 48px; background: #fff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 1.25rem; gap: 1.5rem; position: sticky; top: 0; z-index: 30 }
    .topbar-brand { font-size: 1rem; font-weight: 700; color: #111; text-decoration: none; letter-spacing: -0.02em }
    .topbar-nav { display: flex; gap: 1rem; margin-left: auto }
    .topbar-nav a { font-size: 0.8125rem; color: #555; text-decoration: none }
    .topbar-nav a:hover { color: #111 }

    .container { max-width: 860px; margin: 0 auto; padding: 2rem 1.5rem }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.75rem }
    .page-header h1 { font-size: 1.25rem; font-weight: 700 }

    .btn { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-family: inherit; transition: background 0.15s; text-decoration: none }
    .btn-primary { background: #111; color: #fff }
    .btn-primary:hover { background: #333 }
    .btn-secondary { background: #f0f0f0; color: #333 }
    .btn-secondary:hover { background: #e0e0e0 }
    .btn-danger { background: #fff0f0; color: #c0392b; border: 1px solid #fcc }
    .btn-danger:hover { background: #ffe0e0 }
    .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.8rem }
    .btn:disabled { opacity: 0.5; cursor: not-allowed }

    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 1.25rem 1.5rem; margin-bottom: 1rem }
    .card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; margin-bottom: 1rem }
    .card-title-row { display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap }
    .card-title { font-size: 1rem; font-weight: 600 }
    .card-id { font-size: 0.75rem; color: #888; background: #f5f5f5; padding: 0.15rem 0.5rem; border-radius: 4px; font-family: monospace }
    .card-desc { font-size: 0.8125rem; color: #666; margin-bottom: 0.875rem; line-height: 1.5 }
    .card-sources { margin-bottom: 0.875rem }
    .sources-label { font-size: 0.75rem; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4rem }
    .source-url { font-size: 0.8rem; color: #0969da; word-break: break-all; line-height: 1.6; display: flex; align-items: flex-start; gap: 0.4rem }
    .source-url::before { content: '•'; color: #ccc; flex-shrink: 0; margin-top: 0.1rem }
    .source-more { font-size: 0.75rem; color: #aaa; margin-top: 0.2rem; padding-left: 1rem }
    .card-meta-row { display: flex; gap: 1.5rem; font-size: 0.75rem; color: #aaa; margin-bottom: 0.875rem }
    .card-actions { display: flex; gap: 0.5rem; flex-wrap: wrap }

    .empty-state { text-align: center; padding: 4rem 2rem; color: #aaa }
    .empty-state p { font-size: 0.9375rem; margin-bottom: 1rem }
    .loading-state { text-align: center; padding: 3rem; color: #aaa; font-size: 0.9rem }

    .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 0.625rem 1.25rem; border-radius: 8px; font-size: 0.875rem; z-index: 100; opacity: 0; transition: opacity 0.2s; pointer-events: none }
    .toast.show { opacity: 1 }
    .toast.error { background: #c0392b }

    /* ── Modal ── */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 50; display: none; align-items: flex-start; justify-content: center; padding-top: 5vh; overflow-y: auto }
    .overlay.open { display: flex }
    .modal { background: #fff; border-radius: 12px; width: 100%; max-width: 560px; padding: 1.75rem; margin: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.15) }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem }
    .modal-title { font-size: 1.0625rem; font-weight: 600 }
    .modal-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #888; padding: 0.25rem; line-height: 1 }
    .modal-close:hover { color: #111 }
    .form-group { margin-bottom: 1.125rem }
    .form-label { display: block; font-size: 0.8125rem; font-weight: 500; color: #444; margin-bottom: 0.4rem }
    .form-hint { font-size: 0.75rem; color: #aaa; margin-top: 0.3rem }
    .form-input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.875rem; font-family: inherit; outline: none; transition: border 0.15s }
    .form-input:focus { border-color: #111 }
    .form-input:disabled { background: #f8f8f8; color: #aaa }
    textarea.form-input { resize: vertical; min-height: 120px; font-family: monospace; font-size: 0.8125rem }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem }
    .modal-footer { display: flex; justify-content: flex-end; gap: 0.625rem; margin-top: 1.75rem; padding-top: 1.25rem; border-top: 1px solid #f0f0f0 }

    @media (max-width: 500px) {
      .form-row { grid-template-columns: 1fr }
      .card-header { flex-direction: column }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <a class="topbar-brand" href="/">RssAny</a>
    <nav class="topbar-nav">
      <a href="/feed">信息流</a>
      <a href="/subscriptions" class="active" style="color:#111;font-weight:500">订阅管理</a>
      <a href="/sites">站点配置</a>
      <a href="/plugins">插件</a>
    </nav>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>订阅管理</h1>
      <button class="btn btn-primary" onclick="openModal()">＋ 新建订阅</button>
    </div>
    <div id="loading" class="loading-state">加载中…</div>
    <div id="sub-list"></div>
  </div>

  <!-- 新建/编辑 Modal -->
  <div class="overlay" id="overlay" onclick="handleOverlayClick(event)">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="modal-title">新建订阅</span>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div class="form-group">
        <label class="form-label" for="f-id">订阅 ID <span style="color:#c00">*</span></label>
        <input class="form-input" id="f-id" placeholder="tech / ai-feeds / my-blog" autocomplete="off">
        <p class="form-hint">唯一标识，创建后不可修改；用于 /subscription/{id} 接口</p>
      </div>
      <div class="form-group">
        <label class="form-label" for="f-title">标题</label>
        <input class="form-input" id="f-title" placeholder="科技信息流">
      </div>
      <div class="form-group">
        <label class="form-label" for="f-desc">描述</label>
        <input class="form-input" id="f-desc" placeholder="（可选）">
      </div>
      <div class="form-group">
        <label class="form-label" for="f-sources">信源 URL <span style="color:#c00">*</span></label>
        <textarea class="form-input" id="f-sources" placeholder="每行一个 URL，例如：&#10;https://www.xiaohongshu.com/user/profile/xxx&#10;https://x.com/someone"></textarea>
        <p class="form-hint">每行一个列表页 URL，对应 /rss/{url} 的 url 参数</p>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="f-max">每源最多条目</label>
          <input class="form-input" id="f-max" type="number" min="1" max="200" placeholder="20（留空不限制）">
        </div>
        <div class="form-group">
          <label class="form-label" for="f-interval">定时拉取间隔</label>
          <select class="form-input" id="f-interval">
            <option value="">不自动拉取</option>
            <option value="10min">每 10 分钟</option>
            <option value="30min">每 30 分钟</option>
            <option value="1h">每 1 小时</option>
            <option value="6h">每 6 小时</option>
            <option value="12h">每 12 小时</option>
            <option value="1day">每天</option>
            <option value="3day">每 3 天</option>
            <option value="7day">每周</option>
          </select>
          <p class="form-hint">服务运行期间按此间隔自动拉取所有信源</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">取消</button>
        <button class="btn btn-primary" id="modal-save" onclick="saveSubscription()">保存</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let editingId = null;
    let currentSubs = [];

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function showToast(msg, isError) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show' + (isError ? ' error' : '');
      clearTimeout(t._timer);
      t._timer = setTimeout(() => { t.className = 'toast' }, 3000);
    }

    async function loadSubscriptions() {
      try {
        const res = await fetch('/api/subscription');
        currentSubs = await res.json();
        document.getElementById('loading').style.display = 'none';
        renderList();
      } catch (err) {
        document.getElementById('loading').textContent = '加载失败: ' + err.message;
      }
    }

    function renderList() {
      const container = document.getElementById('sub-list');
      if (!currentSubs.length) {
        container.innerHTML = `<div class="empty-state"><p>暂无订阅</p><button class="btn btn-primary" onclick="openModal()">＋ 新建第一个订阅</button></div>`;
        return;
      }
      container.innerHTML = currentSubs.map(sub => {
        const sources = sub.sources || [];
        const shownSources = sources.slice(0, 3);
        const extraCount = sources.length - shownSources.length;
        const sourceHtml = shownSources.map(s => `<div class="source-url">${escapeHtml(s.url)}</div>`).join('') + (extraCount > 0 ? `<div class="source-more">…还有 ${extraCount} 个信源</div>` : '');
        return `<div class="card" data-id="${escapeHtml(sub.id)}">
          <div class="card-header">
            <div>
              <div class="card-title-row">
                <span class="card-title">${escapeHtml(sub.title || sub.id)}</span>
                <span class="card-id">${escapeHtml(sub.id)}</span>
              </div>
              ${sub.description ? `<p class="card-desc" style="margin-top:0.4rem">${escapeHtml(sub.description)}</p>` : ''}
            </div>
          </div>
          <div class="card-sources"><div class="sources-label">信源（${sources.length}）</div>${sourceHtml || '<div style="font-size:0.8rem;color:#bbb">暂无信源</div>'}</div>
          ${(sub.maxItemsPerSource || sub.pullInterval) ? `<div class="card-meta-row">${sub.maxItemsPerSource ? `<span>每源最多 ${sub.maxItemsPerSource} 条</span>` : ''}${sub.pullInterval ? `<span>定时拉取：${escapeHtml(sub.pullInterval)}</span>` : ''}</div>` : ''}
          <div class="card-actions">
            <a class="btn btn-secondary btn-sm" href="/subscription/${encodeURIComponent(sub.id)}" target="_blank">查看条目 JSON</a>
            <button class="btn btn-secondary btn-sm" onclick="openEdit('${escapeHtml(sub.id)}')">编辑</button>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete('${escapeHtml(sub.id)}')">删除</button>
          </div>
        </div>`;
      }).join('');
    }

    function openModal(idToEdit) {
      editingId = idToEdit || null;
      document.getElementById('modal-title').textContent = editingId ? '编辑订阅' : '新建订阅';
      document.getElementById('f-id').disabled = !!editingId;
      if (!editingId) {
        document.getElementById('f-id').value = '';
        document.getElementById('f-title').value = '';
        document.getElementById('f-desc').value = '';
        document.getElementById('f-sources').value = '';
        document.getElementById('f-max').value = '';
        document.getElementById('f-interval').value = '';
      }
      document.getElementById('overlay').classList.add('open');
      if (!editingId) document.getElementById('f-id').focus();
    }

    function openEdit(id) {
      const sub = currentSubs.find(s => s.id === id);
      if (!sub) return;
      document.getElementById('f-id').value = sub.id;
      document.getElementById('f-title').value = sub.title || '';
      document.getElementById('f-desc').value = sub.description || '';
      document.getElementById('f-sources').value = (sub.sources || []).map(s => s.url).join('\n');
      document.getElementById('f-max').value = sub.maxItemsPerSource || '';
      document.getElementById('f-interval').value = sub.pullInterval || '';
      openModal(id);
    }

    function closeModal() {
      document.getElementById('overlay').classList.remove('open');
      editingId = null;
    }

    function handleOverlayClick(e) {
      if (e.target === document.getElementById('overlay')) closeModal();
    }

    async function saveSubscription() {
      const id = document.getElementById('f-id').value.trim();
      const title = document.getElementById('f-title').value.trim();
      const desc = document.getElementById('f-desc').value.trim();
      const rawSources = document.getElementById('f-sources').value;
      const maxItems = document.getElementById('f-max').value;
      if (!editingId && !id) { showToast('请填写订阅 ID', true); return; }
      const sources = rawSources.split('\n').map(l => l.trim()).filter(Boolean).map(url => ({ url }));
      if (!sources.length) { showToast('请至少添加一个信源 URL', true); return; }
      const interval = document.getElementById('f-interval').value;
      const config = { title: title || undefined, description: desc || undefined, sources, maxItemsPerSource: maxItems ? Number(maxItems) : undefined, pullInterval: interval || undefined };
      const saveBtn = document.getElementById('modal-save');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中…';
      try {
        const targetId = editingId || id;
        const method = editingId ? 'PUT' : 'POST';
        const url = editingId ? `/api/subscription/${encodeURIComponent(editingId)}` : '/api/subscription';
        const body = editingId ? config : { id, ...config };
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const result = await res.json();
        if (!result.ok) throw new Error(result.message || '保存失败');
        closeModal();
        showToast(editingId ? '已更新' : `已创建订阅 "${targetId}"`);
        await loadSubscriptions();
      } catch (err) {
        showToast(err.message, true);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    }

    async function confirmDelete(id) {
      if (!confirm(`确定删除订阅 "${id}"？此操作不可撤销。`)) return;
      try {
        const res = await fetch(`/api/subscription/${encodeURIComponent(id)}`, { method: 'DELETE' });
        const result = await res.json();
        if (!result.ok) throw new Error(result.message || '删除失败');
        showToast(`已删除订阅 "${id}"`);
        await loadSubscriptions();
      } catch (err) {
        showToast(err.message, true);
      }
    }

    loadSubscriptions();
  </script>
</body>

</html>
