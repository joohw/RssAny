<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Preview - RssAny</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; color: #111; height: 100vh; overflow: hidden; display: flex; flex-direction: column }
    .topbar { height: 48px; background: #fff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 1.25rem; gap: 1.5rem; flex-shrink: 0; z-index: 20 }
    .topbar-brand { font-size: 1rem; font-weight: 700; color: #111; text-decoration: none; letter-spacing: -0.02em }
    .topbar-nav { display: flex; gap: 1rem; margin-left: auto; align-items: center }
    .topbar-nav a { font-size: 0.8125rem; color: #555; text-decoration: none }
    .topbar-nav a:hover { color: #111 }

    .feed-wrap { flex: 1; display: flex; overflow: hidden; max-width: 720px; width: 100%; margin: 0 auto }
    .feed-col { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb }

    .feed-header { padding: 0.875rem 1.25rem; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0 }
    .feed-header-url { flex: 1; min-width: 0; font-size: 0.8rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis }
    .feed-header-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0 }
    .btn-copy { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; background: #111; color: #fff; border: none; border-radius: 6px; font-size: 0.775rem; cursor: pointer; font-family: inherit; transition: background 0.15s; white-space: nowrap }
    .btn-copy:hover { background: #333 }
    .btn-copy.copied { background: #16a34a }
    .btn-rss { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; background: none; color: #888; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.775rem; cursor: pointer; text-decoration: none; font-family: inherit; transition: all 0.15s; white-space: nowrap }
    .btn-rss:hover { color: #111; border-color: #aaa }
    .refresh-btn { font-size: 0.75rem; color: #888; background: none; border: none; cursor: pointer; padding: 0.2rem 0.4rem; border-radius: 4px; font-family: inherit }
    .refresh-btn:hover { color: #111; background: #f5f5f5 }
    .refresh-btn.loading { opacity: 0.5; pointer-events: none }

    .feed-list { flex: 1; overflow-y: auto }
    .feed-list::-webkit-scrollbar { width: 4px }
    .feed-list::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px }

    .item { padding: 1rem 1.25rem; border-bottom: 1px solid #f3f3f3; transition: background 0.1s }
    .item:hover { background: #fafafa }
    .item-title { font-size: 0.9rem; font-weight: 500; color: #111; text-decoration: none; display: block; line-height: 1.45; margin-bottom: 0.3rem }
    .item-title:hover { color: #0969da }
    .item-summary { font-size: 0.8rem; color: #666; line-height: 1.55; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 0.4rem }
    .item-meta { display: flex; align-items: center; gap: 0.6rem; font-size: 0.725rem; color: #bbb }
    .item-author { max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap }
    .item-dot { width: 2px; height: 2px; background: #ccc; border-radius: 50%; flex-shrink: 0 }

    .state { padding: 3rem 1.5rem; text-align: center; color: #aaa; font-size: 0.875rem; line-height: 1.7 }

    @media (max-width: 600px) { .feed-wrap { max-width: 100% } .feed-col { border: none } }
  </style>
</head>

<body>
  <div class="topbar">
    <a class="topbar-brand" href="/">RssAny</a>
    <nav class="topbar-nav">
      <a href="/feed">信息流</a>
      <a href="/subscriptions">订阅管理</a>
      <a href="/plugins">插件</a>
    </nav>
  </div>

  <div class="feed-wrap">
    <div class="feed-col">
      <div class="feed-header">
        <div class="feed-header-url" id="meta-url"></div>
        <div class="feed-header-actions">
          <button class="refresh-btn" id="refresh-btn" onclick="load(true)">↺ 刷新</button>
          <a id="btn-open-rss" class="btn-rss" target="_blank" rel="noopener">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="18" r="3"/><path d="M4 6a16 16 0 0 1 16 16"/><path d="M4 11a11 11 0 0 1 11 11"/></svg>
            RSS
          </a>
          <button class="btn-copy" id="btn-copy" onclick="copyRss()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            复制
          </button>
        </div>
      </div>
      <div class="feed-list" id="feed-list">
        <div class="state" id="feed-state">加载中…</div>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const feedUrl = params.get('url') || '';
    const headless = params.get('headless') === 'false' ? 'false' : null;

    if (feedUrl) {
      document.title = 'Preview – ' + new URL(feedUrl).hostname;
      document.getElementById('meta-url').textContent = feedUrl;
      document.getElementById('btn-open-rss').href = rssUrl();
      load();
    } else {
      document.getElementById('feed-state').textContent = '缺少 url 参数，请在 URL 中提供 ?url=https://…';
    }


    function rssUrl() {
      return location.origin + '/rss/' + encodeURIComponent(feedUrl);
    }


    function copyRss() {
      navigator.clipboard.writeText(rssUrl()).then(() => {
        const btn = document.getElementById('btn-copy');
        btn.textContent = '✓ 已复制';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> 复制`;
          btn.classList.remove('copied');
        }, 2000);
      });
    }


    function relativeTime(dateStr) {
      if (!dateStr) return '';
      const diff = Date.now() - new Date(dateStr).getTime();
      const m = Math.floor(diff / 60000);
      if (m < 1) return '刚刚';
      if (m < 60) return m + ' 分钟前';
      const h = Math.floor(m / 60);
      if (h < 24) return h + ' 小时前';
      const d = Math.floor(h / 24);
      if (d < 30) return d + ' 天前';
      return new Date(dateStr).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    }


    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }


    function renderItems(items) {
      const list = document.getElementById('feed-list');
      const state = document.getElementById('feed-state');
      list.querySelectorAll('.item').forEach(el => el.remove());
      if (items.length === 0) {
        state.style.display = '';
        state.textContent = '暂无条目';
        return;
      }
      state.style.display = 'none';
      items.forEach(item => {
        const el = document.createElement('div');
        el.className = 'item';
        const summaryHtml = item.summary ? `<p class="item-summary">${esc(item.summary)}</p>` : '';
        const authorHtml = item.author ? `<span class="item-author">${esc(item.author)}</span><span class="item-dot"></span>` : '';
        el.innerHTML = `
          <a class="item-title" href="${esc(item.link)}" target="_blank" rel="noopener">${esc(item.title || '(无标题)')}</a>
          ${summaryHtml}
          <div class="item-meta">${authorHtml}<span>${relativeTime(item.pubDate)}</span></div>`;
        list.appendChild(el);
      });
    }


    async function load(manual = false) {
      const btn = document.getElementById('refresh-btn');
      const state = document.getElementById('feed-state');
      if (manual) {
        btn.classList.add('loading');
        btn.textContent = '↺ 加载中…';
        document.getElementById('feed-list').querySelectorAll('.item').forEach(el => el.remove());
        state.style.display = '';
        state.textContent = '加载中…';
      }
      const apiUrl = '/api/rss?url=' + encodeURIComponent(feedUrl) + (headless ? '&headless=false' : '');
      try {
        const resp = await fetch(apiUrl);
        const data = await resp.json();
        if (!resp.ok) {
          state.style.display = '';
          state.textContent = data.code === 'AUTH_REQUIRED'
            ? '该站点需要登录，请先在「插件管理」页面完成认证'
            : (data.error || `请求失败 HTTP ${resp.status}`);
          return;
        }
        renderItems(data.items || []);
      } catch (e) {
        state.style.display = '';
        state.textContent = '请求失败: ' + e.message;
      } finally {
        btn.classList.remove('loading');
        btn.textContent = '↺ 刷新';
      }
    }
  </script>
</body>

</html>
