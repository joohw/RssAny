<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>站点配置 - RssAny</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; color: #111 }

    .topbar { height: 48px; background: #fff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 1.25rem; gap: 1.5rem; position: sticky; top: 0; z-index: 30 }
    .topbar-brand { font-size: 1rem; font-weight: 700; color: #111; text-decoration: none; letter-spacing: -0.02em }
    .topbar-nav { display: flex; gap: 1rem; margin-left: auto }
    .topbar-nav a { font-size: 0.8125rem; color: #555; text-decoration: none }
    .topbar-nav a:hover { color: #111 }
    .topbar-nav a.active { color: #111; font-weight: 500 }

    .container { max-width: 860px; margin: 0 auto; padding: 2rem 1.5rem }
    .page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1.75rem; gap: 1rem }
    .page-header-left h1 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.3rem }
    .page-desc { font-size: 0.8125rem; color: #888; line-height: 1.6; max-width: 560px }

    .btn { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-family: inherit; transition: background 0.15s; text-decoration: none; flex-shrink: 0 }
    .btn-primary { background: #111; color: #fff }
    .btn-primary:hover { background: #333 }
    .btn-secondary { background: #f0f0f0; color: #333 }
    .btn-secondary:hover { background: #e0e0e0 }
    .btn-danger { background: #fff0f0; color: #c0392b; border: 1px solid #fcc }
    .btn-danger:hover { background: #ffe0e0 }
    .btn-sm { padding: 0.3rem 0.65rem; font-size: 0.8rem }
    .btn:disabled { opacity: 0.5; cursor: not-allowed }

    .info-box { background: #f8f9ff; border: 1px solid #dde4ff; border-radius: 8px; padding: 1rem 1.25rem; margin-bottom: 1.75rem; font-size: 0.8125rem; color: #555; line-height: 1.7 }
    .info-box strong { color: #111 }
    .info-box code { background: #eef; padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.8rem; font-family: monospace }
    .info-box ul { padding-left: 1.2rem; margin-top: 0.4rem }
    .info-box li { margin-bottom: 0.2rem }

    .table-wrap { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; margin-bottom: 1rem }
    table { width: 100%; border-collapse: collapse }
    thead th { background: #fafafa; font-size: 0.75rem; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.6rem 1rem; text-align: left; border-bottom: 1px solid #f0f0f0 }
    tbody tr { border-bottom: 1px solid #f5f5f5; transition: background 0.1s }
    tbody tr:last-child { border-bottom: none }
    tbody tr:hover { background: #fafafa }
    td { padding: 0.75rem 1rem; font-size: 0.875rem; vertical-align: middle }
    .td-pattern { font-family: monospace; font-size: 0.8rem; color: #111; word-break: break-all; max-width: 260px }
    .td-proxy { font-size: 0.8rem; color: #555; font-family: monospace; word-break: break-all; max-width: 200px }
    .td-refresh { font-size: 0.8rem }
    .refresh-badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; background: #f0f0f0; color: #555; font-size: 0.75rem }
    .td-actions { white-space: nowrap; text-align: right }
    .empty-row td { text-align: center; color: #bbb; padding: 3rem; font-size: 0.875rem }

    .loading-row td { text-align: center; color: #bbb; padding: 2rem; font-size: 0.875rem }

    .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 0.625rem 1.25rem; border-radius: 8px; font-size: 0.875rem; z-index: 100; opacity: 0; transition: opacity 0.2s; pointer-events: none; white-space: nowrap }
    .toast.show { opacity: 1 }
    .toast.error { background: #c0392b }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 50; display: none; align-items: flex-start; justify-content: center; padding-top: 8vh; overflow-y: auto }
    .overlay.open { display: flex }
    .modal { background: #fff; border-radius: 12px; width: 100%; max-width: 520px; padding: 1.75rem; margin: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.15) }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem }
    .modal-title { font-size: 1.0625rem; font-weight: 600 }
    .modal-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #888; padding: 0.25rem; line-height: 1 }
    .modal-close:hover { color: #111 }
    .form-group { margin-bottom: 1.125rem }
    .form-label { display: block; font-size: 0.8125rem; font-weight: 500; color: #444; margin-bottom: 0.4rem }
    .form-hint { font-size: 0.75rem; color: #aaa; margin-top: 0.3rem; line-height: 1.5 }
    .form-input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.875rem; font-family: monospace; outline: none; transition: border 0.15s }
    .form-input:focus { border-color: #111 }
    .form-input:disabled { background: #f8f8f8; color: #aaa }
    select.form-input { font-family: inherit }
    .modal-footer { display: flex; justify-content: flex-end; gap: 0.625rem; margin-top: 1.75rem; padding-top: 1.25rem; border-top: 1px solid #f0f0f0 }

    @media (max-width: 600px) {
      .td-proxy { display: none }
      th:nth-child(2) { display: none }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <a class="topbar-brand" href="/">RssAny</a>
    <nav class="topbar-nav">
      <a href="/feed">信息流</a>
      <a href="/subscriptions">订阅管理</a>
      <a href="/sites" class="active">站点配置</a>
      <a href="/plugins">插件</a>
    </nav>
  </div>

  <div class="container">
    <div class="page-header">
      <div class="page-header-left">
        <h1>站点配置</h1>
        <p class="page-desc">管理 sites.json，为任意站点添加代理和刷新间隔规则</p>
      </div>
      <button class="btn btn-primary" onclick="openModal()">＋ 添加规则</button>
    </div>

    <div class="info-box">
      <strong>匹配规则</strong>：key 为 URL 正则表达式，请求 URL 与 pattern 匹配时应用对应配置。多条 pattern 同时命中时，<strong>越长的 pattern 越具体</strong>，各字段独立取最具体的值。
      <ul>
        <li><code>proxy</code> — 代理地址，格式 <code>http://host:port</code> 或 <code>socks5://host:port</code></li>
        <li><code>refresh</code> — 刷新间隔，决定 feed 缓存的时间窗口，可选值：<code>10min</code> <code>30min</code> <code>1h</code> <code>6h</code> <code>12h</code> <code>1day</code> <code>3day</code> <code>7day</code>（省略则默认 <code>1day</code>）</li>
      </ul>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>URL 正则 (pattern)</th>
            <th>代理 (proxy)</th>
            <th>刷新间隔 (refresh)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr class="loading-row"><td colspan="4">加载中…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="overlay" id="overlay" onclick="handleOverlayClick(event)">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="modal-title">添加规则</span>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <div class="form-group">
        <label class="form-label" for="f-pattern">URL 正则 (pattern) <span style="color:#c00">*</span></label>
        <input class="form-input" id="f-pattern" placeholder="xiaohongshu\\.com" autocomplete="off" spellcheck="false">
        <p class="form-hint">不需要加 / 包裹，直接写正则内容。例：<code>xiaohongshu\\.com</code>、<code>^https://x\\.com/</code></p>
      </div>
      <div class="form-group">
        <label class="form-label" for="f-proxy">代理 (proxy)</label>
        <input class="form-input" id="f-proxy" placeholder="http://127.0.0.1:7890（留空则不使用代理）" spellcheck="false">
      </div>
      <div class="form-group">
        <label class="form-label" for="f-refresh">刷新间隔 (refresh)</label>
        <select class="form-input" id="f-refresh">
          <option value="">默认 (1day)</option>
          <option value="10min">10 分钟</option>
          <option value="30min">30 分钟</option>
          <option value="1h">1 小时</option>
          <option value="6h">6 小时</option>
          <option value="12h">12 小时</option>
          <option value="1day">1 天</option>
          <option value="3day">3 天</option>
          <option value="7day">7 天</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">取消</button>
        <button class="btn btn-primary" id="modal-save" onclick="saveEntry()">保存</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let editingPattern = null;
    let currentEntries = [];

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function showToast(msg, isError) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show' + (isError ? ' error' : '');
      clearTimeout(t._timer);
      t._timer = setTimeout(() => { t.className = 'toast' }, 3000);
    }

    async function loadEntries() {
      try {
        const res = await fetch('/api/sites');
        currentEntries = await res.json();
        renderTable();
      } catch (err) {
        document.getElementById('table-body').innerHTML = `<tr><td colspan="4" style="text-align:center;color:#c00;padding:2rem">加载失败: ${escapeHtml(err.message)}</td></tr>`;
      }
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      if (!currentEntries.length) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="4">暂无配置，点击「添加规则」开始</td></tr>';
        return;
      }
      tbody.innerHTML = currentEntries.map(entry => `
        <tr>
          <td class="td-pattern">${escapeHtml(entry.pattern)}</td>
          <td class="td-proxy">${entry.proxy ? escapeHtml(entry.proxy) : '<span style="color:#ccc">—</span>'}</td>
          <td class="td-refresh">${entry.refresh ? `<span class="refresh-badge">${escapeHtml(entry.refresh)}</span>` : '<span style="color:#ccc">默认</span>'}</td>
          <td class="td-actions">
            <button class="btn btn-secondary btn-sm" onclick="openEdit(${JSON.stringify(entry.pattern)})" style="margin-right:0.4rem">编辑</button>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete(${JSON.stringify(entry.pattern)})">删除</button>
          </td>
        </tr>`).join('');
    }

    function openModal(patternToEdit) {
      editingPattern = patternToEdit || null;
      document.getElementById('modal-title').textContent = editingPattern ? '编辑规则' : '添加规则';
      document.getElementById('f-pattern').disabled = !!editingPattern;
      if (!editingPattern) {
        document.getElementById('f-pattern').value = '';
        document.getElementById('f-proxy').value = '';
        document.getElementById('f-refresh').value = '';
      }
      document.getElementById('overlay').classList.add('open');
      if (!editingPattern) document.getElementById('f-pattern').focus();
    }

    function openEdit(pattern) {
      const entry = currentEntries.find(e => e.pattern === pattern);
      if (!entry) return;
      document.getElementById('f-pattern').value = entry.pattern;
      document.getElementById('f-proxy').value = entry.proxy || '';
      document.getElementById('f-refresh').value = entry.refresh || '';
      openModal(pattern);
    }

    function closeModal() {
      document.getElementById('overlay').classList.remove('open');
      editingPattern = null;
    }

    function handleOverlayClick(e) {
      if (e.target === document.getElementById('overlay')) closeModal();
    }

    async function saveEntry() {
      const pattern = editingPattern || document.getElementById('f-pattern').value.trim();
      const proxy = document.getElementById('f-proxy').value.trim();
      const refresh = document.getElementById('f-refresh').value;
      if (!pattern) { showToast('请填写 URL 正则', true); return; }
      const saveBtn = document.getElementById('modal-save');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中…';
      try {
        const res = await fetch('/api/sites', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pattern, proxy: proxy || undefined, refresh: refresh || undefined })
        });
        const result = await res.json();
        if (!result.ok) throw new Error(result.message || '保存失败');
        closeModal();
        showToast(editingPattern ? '已更新' : `已添加规则`);
        await loadEntries();
      } catch (err) {
        showToast(err.message, true);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    }

    async function confirmDelete(pattern) {
      if (!confirm(`确定删除规则 "${pattern}"？`)) return;
      try {
        const res = await fetch('/api/sites', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pattern })
        });
        const result = await res.json();
        if (!result.ok) throw new Error(result.message || '删除失败');
        showToast(`已删除规则 "${pattern}"`);
        await loadEntries();
      } catch (err) {
        showToast(err.message, true);
      }
    }

    loadEntries();
  </script>
</body>

</html>
